import{_ as a,c as i,o as t,a9 as p}from"./chunks/framework.CKUMok-g.js";const c=JSON.parse('{"title":"记一次服务器迁移","description":"","frontmatter":{"tag":["杂记","迁移"],"head":[["script",{},"!function(p){\\"use strict\\";!function(t){var s=window,e=document,i=p,c=\\"\\".concat(\\"https:\\"===e.location.protocol?\\"https://\\":\\"http://\\",\\"sdk.51.la/js-sdk-pro.min.js\\"),n=e.createElement(\\"script\\"),r=e.getElementsByTagName(\\"script\\")[0];n.type=\\"text/javascript\\",n.setAttribute(\\"charset\\",\\"UTF-8\\"),n.async=!0,n.src=c,n.id=\\"LA_COLLECT\\",i.d=n;var o=function(){s.LA.ids.push(i)};s.LA?s.LA.ids&&o():(s.LA=p,s.LA.ids=[],o()),r.parentNode.insertBefore(n,r)}()}({\\"id\\":\\"Jgmg5avjAUvoyePS\\",\\"ck\\":\\"Jgmg5avjAUvoyePS\\",\\"hashMode\\":true});"]]},"headers":[],"relativePath":"essay/dev/migrate-bt-server.md","filePath":"essay/dev/migrate-bt-server.md","lastUpdated":1769849351000}'),e={name:"essay/dev/migrate-bt-server.md"};function l(h,s,n,r,k,d){return t(),i("div",{"data-pagefind-body":!0,"data-pagefind-meta":"date:1769849351000"},[...s[0]||(s[0]=[p(`<h1 id="记一次服务器迁移" tabindex="-1">记一次服务器迁移 <a class="header-anchor" href="#记一次服务器迁移" aria-label="Permalink to “记一次服务器迁移”">​</a></h1><p>服务器又要过期了，上一次的机器也是3年前的双十一购入的。</p><p><img src="https://cdn.upyun.sugarat.top/mdImg/sugar/5c3d1b1e6475eafcf0a6873b01edb761" alt="" loading="lazy"></p><p>新买的配置比之前的带宽和核心数低一点，不过日常跑跑小demo服务&amp;博客也差不多够用。</p><p>今年双十一的活动也还行，159 买一年送3个月。(300块 30个月也还不错)</p><p><img src="https://cdn.upyun.sugarat.top/mdImg/sugar/8ed6e6d353a9cce38fed85e46abcb33c" alt="" loading="lazy"></p><p>本文记录分享一下整个服务迁移的过程。（不一定是最佳实践 ❤️）</p><h2 id="迁移前准备" tabindex="-1">迁移前准备 <a class="header-anchor" href="#迁移前准备" aria-label="Permalink to “迁移前准备”">​</a></h2><h3 id="盘点" tabindex="-1">盘点 <a class="header-anchor" href="#盘点" aria-label="Permalink to “盘点”">​</a></h3><ol><li>管理面板</li></ol><p>原服务器使用<a href="https://www.bt.cn/new/index.html" target="_blank" rel="noreferrer">宝塔面板</a>做管理，这块了解到有 <a href="https://1panel.cn/" target="_blank" rel="noreferrer">1Panel</a> 这个平替产品。</p><p>时间比较紧迫，我还是选择沿用宝塔，下次搞个测试机体验一下 1Panel 再看情况替换。</p><ol start="2"><li>服务器软件</li></ol><p>主要就常见的一些软件</p><ul><li>数据库：MySQL，Redis，MongoDB</li><li>其它：Nginx，Node</li></ul><p>这部分使用宝塔面板的软件管理一键安装配置即可。</p><ol start="3"><li>要迁移的服务</li></ol><ul><li>纯静态：博客，demo</li><li>带后端服务：前端 + Node.js 后端 + 数据库</li></ul><h3 id="配置新机环境" tabindex="-1">配置新机环境 <a class="header-anchor" href="#配置新机环境" aria-label="Permalink to “配置新机环境”">​</a></h3><ul><li>新机子 Web 服务器我选择了 Nginx1.25 （提示支持 HTTP3）。</li><li>数据库就按推荐的默认安装。</li><li>Node.js 选择了最新的 Node22。</li></ul><p><em>上述软件的安装，只需要在宝塔上一键操作即可。</em></p><p>过程中只遇到 MongoDB 有问题，需要介入解决一下。</p><p><img src="https://cdn.upyun.sugarat.top/mdImg/sugar/b0821b8b772a75d779dda83cb11135aa" alt="" loading="lazy"></p><p>错误的原因，也是宝塔的安装脚本没有兼容腾讯云的这款机器，在论坛找到了解决办法。</p><p><a href="https://www.bt.cn/bbs/thread-134959-1-1.html" target="_blank" rel="noreferrer">https://www.bt.cn/bbs/thread-134959-1-1.html</a></p><p>安装完 Node.js 之后，顺便安装了 pm2 （用来管理 Node 进程），pnpm（安装依赖）。</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> i</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -g</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pnpm</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> i</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -g</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pm2</span></span></code></pre></div><h2 id="开始迁移" tabindex="-1">开始迁移 <a class="header-anchor" href="#开始迁移" aria-label="Permalink to “开始迁移”">​</a></h2><p>采用一个一个站点迁移的方式，逐步迁移到新服务器上。</p><h3 id="暂停站点访问" tabindex="-1">暂停站点访问 <a class="header-anchor" href="#暂停站点访问" aria-label="Permalink to “暂停站点访问”">​</a></h3><p>① 将网站前端临时指向一个默认的提示页面，避免网站直接无响应，此时访问页面的用户也知道发生了什么。</p><p>创建临时页面地址：<code>/www/wwwroot/migrate/index.html</code></p><p>内容如下：</p><div class="language-html"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;!</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">DOCTYPE</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> html</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">html</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> lang</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;zh-CN&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">head</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">meta</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> charset</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;UTF-8&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">meta</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;viewport&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> content</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;width=device-width, initial-scale=1.0&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">title</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;网站升级中...&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">title</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">head</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">body</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">h1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;网站升级中...&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">h1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;预计15分钟左右恢复正常，请耐心等待。&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">body</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">html</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span></code></pre></div><p>修改网站 Nginx 目录配置为临时文件目录</p><p><img src="https://cdn.upyun.sugarat.top/mdImg/sugar/6d162bf8abcd79047266d7e188b7a68d" alt="" loading="lazy"></p><p>此时访问效果如下：</p><p><img src="https://cdn.upyun.sugarat.top/mdImg/sugar/cd5eb499099f2c95a18103352cd3379e" alt="" loading="lazy"></p><p>② 停止站点关联的后端服务</p><p>防止有用户没刷新停留在原页面，请求接口产生新的数据。</p><p>我这里采用直接停止对应后端服务的方式。</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pm2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> stop</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> serviceName</span></span></code></pre></div><p>如果是反向代理的接口也可以关闭反向代理的配置。</p><p><img src="https://cdn.upyun.sugarat.top/mdImg/sugar/d9bc43494d7e0c4db72bde83d474b9d1" alt="" loading="lazy"></p><h3 id="备份数据库" tabindex="-1">备份数据库 <a class="header-anchor" href="#备份数据库" aria-label="Permalink to “备份数据库”">​</a></h3><p>宝塔提供了一键备份的功能。</p><p><img src="https://cdn.upyun.sugarat.top/mdImg/sugar/95fd40cc72bbd73f9c13c670beada7c0" alt="" loading="lazy"></p><p>备份完后，可以将其下载下来，后面在新服务器上进行导入。</p><h3 id="创建新站点" tabindex="-1">创建新站点 <a class="header-anchor" href="#创建新站点" aria-label="Permalink to “创建新站点”">​</a></h3><p>这个就使用宝塔面板默认的创建功能即可。</p><p><img src="https://cdn.upyun.sugarat.top/mdImg/sugar/f5c6e794fed14ef29e5471b2e91cc0e6" alt="" loading="lazy"></p><h3 id="迁移站点配置和数据" tabindex="-1">迁移站点配置和数据 <a class="header-anchor" href="#迁移站点配置和数据" aria-label="Permalink to “迁移站点配置和数据”">​</a></h3><p>① 同步前端资源</p><p>使用宝塔内置的压缩工具，将需要的资源压缩打包下载。</p><p><img src="https://cdn.upyun.sugarat.top/mdImg/sugar/3bdaf70a11209ebbff723b149d032cf3" alt="" loading="lazy"></p><p>上传解压到新站点对应的目录下。</p><p>② 同步 Nginx 配置</p><p>我这块主要就是是反向代理和 SPA 的配置</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">location</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  try_files</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $uri $uri</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /index.html</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>③ SSL 证书</p><p>可以直接拷贝过来旧的证书。</p><p><img src="https://cdn.upyun.sugarat.top/mdImg/sugar/6780baa522e2c8372afd0eeb0d3c8702" alt="" loading="lazy"></p><p>宝塔上操作也比较方便，CV 一下就可以了。</p><p>④ 数据库</p><p>创建同名数据库，账号和密码与之前的保持一致。</p><p>然后将备份的数据一键导入，包含 MongoDB 和 MySQL。</p><p><img src="https://cdn.upyun.sugarat.top/mdImg/sugar/0f798a01ce7c2a704c8d51678a31a156" alt="" loading="lazy"></p><p>⑤ 后端服务资源</p><p>都是 Node.js 项目，将除 node_modules 外的资源压缩下载，导入到新机器上。</p><p>使用 pm2 启动服务。</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pm2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> start</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> npm</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> serviceName</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> start</span></span></code></pre></div><div class="tip custom-block"><p class="custom-block-title custom-block-title-default">TIP</p><p>要注意的点就是，和之前启动的服务端口保持一致，这样反向代理配置也可以直接拷贝过来用。</p></div><p>⑥ 配置反向代理</p><p>新服务到这里就在新服务器上跑起来了。</p><p>检查一下后端服务的启动日志是否正常，就可以做最后一步的域名转发配置了。</p><h3 id="修改域名指向" tabindex="-1">修改域名指向 <a class="header-anchor" href="#修改域名指向" aria-label="Permalink to “修改域名指向”">​</a></h3><p>最后一步了，修改域名的 DNS 解析设置，将域名指向到新服务器的 IP 地址。</p><p>大概10分钟左右就生效。</p><p>这样一个站点的迁移就搞定了。</p><h2 id="其它坑" tabindex="-1">其它坑 <a class="header-anchor" href="#其它坑" aria-label="Permalink to “其它坑”">​</a></h2><h3 id="ds-store-文件" tabindex="-1">.DS_Store 文件 <a class="header-anchor" href="#ds-store-文件" aria-label="Permalink to “.DS_Store 文件”">​</a></h3><p>之前有些文件是从 Mac 电脑压缩上传的，解压后会产生 <code>.DS_Store</code> 文件，迁移的过程中顺手移除了，存在外部可以访问到的风险。</p><p>搜了一段 Shell，一键删除，来源：<a href="https://www.cnblogs.com/xuyaowen/p/DS_store.html%E3%80%82" target="_blank" rel="noreferrer">https://www.cnblogs.com/xuyaowen/p/DS_store.html。</a></p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 查询当前目录下所有.DS_Store 文件</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">find</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;.&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .DS_Store</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 删除当前目录下所有.DS_Store 文件</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">find</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;.&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .DS_Store</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> xargs</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rm</span></span></code></pre></div><p>主要是腾讯云报告有安全问题说这个，顺手处理了。</p><p><img src="https://cdn.upyun.sugarat.top/mdImg/sugar/53ba8c2fb31cb69812946409fd4700e9" alt="" loading="lazy"></p><h3 id="图片跨域" tabindex="-1">图片跨域 <a class="header-anchor" href="#图片跨域" aria-label="Permalink to “图片跨域”">​</a></h3><p>发现看板娘的 图片加载不出来，一坨黑的！ <img src="https://cdn.upyun.sugarat.top/mdImg/sugar/0d752202cc0a4f523fcf911a4086543b" alt="" loading="lazy"></p><p>再看有个跨域请求。 <img src="https://cdn.upyun.sugarat.top/mdImg/sugar/2d73116c922ce4971db1c1d10962c756" alt="" loading="lazy"></p><p>琢磨了一下，少 CV 了一段针对图片的跨域配置！</p><p><em>SDK 内部应该是用的 new Image() 加载图片，所以触发了跨域的限制。</em></p><p><img src="https://cdn.upyun.sugarat.top/mdImg/sugar/bed3a10c929fd42fe9af5c63cd2162e0" alt="" loading="lazy"></p><h3 id="升级-http3" tabindex="-1">升级 HTTP3 <a class="header-anchor" href="#升级-http3" aria-label="Permalink to “升级 HTTP3”">​</a></h3><p>http3 基于 QUIC 协议，QUIC 又基于 UDP，所以 443 端口得先开放一下 UDP 协议。</p><p>然后再找个网站 <a href="https://http3.wcode.net/?q=https://devzx.top" target="_blank" rel="noreferrer">https://http3.wcode.net/?q=https://devzx.top</a> 检测了一下。</p><p><img src="https://cdn.upyun.sugarat.top/mdImg/sugar/79e617c0ed7b6eaa71a784f2c8b75491" alt="" loading="lazy"></p><p>就说支持了？？？ 我一看没生效啊！</p><p><img src="https://cdn.upyun.sugarat.top/mdImg/sugar/dcff62f55d530ab4b3d5035a47085907" alt="" loading="lazy"></p><p>然后就开始捣鼓了，看<a href="https://nginx.org/en/docs/http/ngx_http_v3_module.html" target="_blank" rel="noreferrer">官方文档</a>。</p><p>还没搞出来，正在折腾中！</p><h2 id="最后" tabindex="-1">最后 <a class="header-anchor" href="#最后" aria-label="Permalink to “最后”">​</a></h2><p>感觉 20 多个站点迁起来还挺费事的，下次迁感觉可以写个脚本自动化搞一搞，这次也算有经验了。</p>`,102)])])}const o=a(e,[["render",l]]);export{c as __pageData,o as default};
