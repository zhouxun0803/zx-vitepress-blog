import{_ as e,c as t,o as r,a9 as d}from"./chunks/framework.CKUMok-g.js";const g=JSON.parse('{"title":"记一次 CDN 流量被盗刷经历","description":"","frontmatter":{"head":[["script",{},"!function(p){\\"use strict\\";!function(t){var s=window,e=document,i=p,c=\\"\\".concat(\\"https:\\"===e.location.protocol?\\"https://\\":\\"http://\\",\\"sdk.51.la/js-sdk-pro.min.js\\"),n=e.createElement(\\"script\\"),r=e.getElementsByTagName(\\"script\\")[0];n.type=\\"text/javascript\\",n.setAttribute(\\"charset\\",\\"UTF-8\\"),n.async=!0,n.src=c,n.id=\\"LA_COLLECT\\",i.d=n;var o=function(){s.LA.ids.push(i)};s.LA?s.LA.ids&&o():(s.LA=p,s.LA.ids=[],o()),r.parentNode.insertBefore(n,r)}()}({\\"id\\":\\"Jgmg5avjAUvoyePS\\",\\"ck\\":\\"Jgmg5avjAUvoyePS\\",\\"hashMode\\":true});"]]},"headers":[],"relativePath":"essay/dev/cdn-ds1.md","filePath":"essay/dev/cdn-ds1.md","lastUpdated":1769849351000}'),c={name:"essay/dev/cdn-ds1.md"};function n(s,a,p,i,l,o){return r(),t("div",{"data-pagefind-body":!0,"data-pagefind-meta":"date:1769849351000"},[...a[0]||(a[0]=[d('<h1 id="记一次-cdn-流量被盗刷经历" tabindex="-1">记一次 CDN 流量被盗刷经历 <a class="header-anchor" href="#记一次-cdn-流量被盗刷经历" aria-label="Permalink to “记一次 CDN 流量被盗刷经历”">​</a></h1><p>先说损失，被刷了 70 多RMB，还好止损相对即时了，亏得不算多，PCDN 真可恶啊。</p><p><img src="https://cdn.upyun.sugarat.top/mdImg/sugar/2aac543c5426b02a67c9666d8ff7a7f4" alt="" loading="lazy"></p><p>600多G流量，100多万次请求。</p><h2 id="怎么发现的" tabindex="-1">怎么发现的 <a class="header-anchor" href="#怎么发现的" aria-label="Permalink to “怎么发现的”">​</a></h2><p>先是看到鱼皮大佬发了一篇推文突发，<a href="https://mp.weixin.qq.com/s/XZMLMqgF_gv_QNNrfHvoPQ" target="_blank" rel="noreferrer">众多网站流量被盗刷！我特么也中招了</a>。</p><p>抱着看热闹的心情点开阅读了。。。心想，看看自己的中招没，结果就真中招了 🍉。</p><h2 id="被盗刷资源分析" tabindex="-1">被盗刷资源分析 <a class="header-anchor" href="#被盗刷资源分析" aria-label="Permalink to “被盗刷资源分析”">​</a></h2><p>笔者在 <code>缤纷云</code>，<code>七牛云</code>，<code>又拍云</code> 都有存放一些图片资源。本次中招的是 <code>缤纷云</code>，下面是被刷的资源。</p><p><img src="https://cdn.upyun.sugarat.top/mdImg/sugar/4f293f2ddd706c756b8883abc9328bed" alt="" loading="lazy"></p><h3 id="ip来源" tabindex="-1">IP来源 <a class="header-anchor" href="#ip来源" aria-label="Permalink to “IP来源”">​</a></h3><p>查了几个 IP 和文章里描述的大差不差，都是来自山西联通的请求。</p><p><img src="https://cdn.upyun.sugarat.top/mdImg/sugar/1df53e3628e0745216e4c7fb452dde07" alt="" loading="lazy"></p><h3 id="大小流量计算" tabindex="-1">大小流量计算 <a class="header-anchor" href="#大小流量计算" aria-label="Permalink to “大小流量计算”">​</a></h3><p>按日志时间算的话，QPS 大概在 20 左右，单文件 632 K，1分钟大概就760MB ，1小时约 45G 左右。</p><p>看了几天前的日志，都是 1 小时刷 40G 就停下，从 9 点左右开始，刷到 12 点。</p><table tabindex="0"><thead><tr><th style="text-align:center;">07-09</th><th style="text-align:center;">07-08</th></tr></thead><tbody><tr><td style="text-align:center;"><img src="https://cdn.upyun.sugarat.top/mdImg/sugar/80abd2526ecf3503e474860f2f6f489e" alt="" loading="lazy"></td><td style="text-align:center;"><img src="https://cdn.upyun.sugarat.top/mdImg/sugar/c5723480c12c5aca0faf18b390f27462" alt="" loading="lazy"></td></tr></tbody></table><p>但是 10 号的就变多了，60-70 GB 1次了。也是这天晚上才开始做的反制，不知道是不是加策略的时候影响到它计算流量大小了 😝。</p><p><img src="https://cdn.upyun.sugarat.top/mdImg/sugar/ad0abdef680288a55ad2ec4587339985" alt="" loading="lazy"></p><h2 id="反制手段" tabindex="-1">反制手段 <a class="header-anchor" href="#反制手段" aria-label="Permalink to “反制手段”">​</a></h2><h3 id="referer-限制" tabindex="-1">Referer 限制 <a class="header-anchor" href="#referer-限制" aria-label="Permalink to “Referer 限制”">​</a></h3><p>通过观察这些资源的请求头，发现 <code>Referer</code> 和请求资源一致，通常情况下，不应该这样，应该是笔者的博客地址<code>https://devzx.top</code>。</p><p><img src="https://cdn.upyun.sugarat.top/mdImg/sugar/c6a33d8aa82bea53371ec92e3acaf469" alt="" loading="lazy"></p><p>于是第一次就限制了 <code>Referer</code> 头不能为空，同时将 <code>cdn.bitiful.sugarat.top</code> 的来源都拉黑。</p><p>这个办法还比较好使，后面的请求都给 403 了。</p><p><img src="https://cdn.upyun.sugarat.top/mdImg/sugar/8e0934d612bc6884552d6c84a286bce4" alt="" loading="lazy"></p><p>但这个还是临时解决方案，在 V 站上看到讨论，说资源是人为筛选的，意味着 Referer 换个资源还是会发生变化。</p><h3 id="ip-限制" tabindex="-1">IP 限制 <a class="header-anchor" href="#ip-限制" aria-label="Permalink to “IP 限制”">​</a></h3><p>有 GitHub 仓库 <a href="https://github.com/unclemcz/ban-pcdn-ip" target="_blank" rel="noreferrer">unclemcz/ban-pcdn-ip</a> 收集了此次恶意刷流量的 IP。</p><p>CDN 平台一般支持按 IP 或 IP 段屏蔽请求（虽然后者可能会屏蔽一些正常请求），可以将 IP 段配置到平台上，这样就能限制掉这些 IP 的请求。</p><p>缤纷云上这块限制还比较弱，我就直接把缤纷云的 CDN 直接关了，七牛云和又拍云上都加上了 IP 和 地域运营商的限制，等这阵风头过去再恢复。</p><table tabindex="0"><thead><tr><th style="text-align:center;">七牛云</th><th style="text-align:center;">又拍云</th></tr></thead><tbody><tr><td style="text-align:center;"><img src="https://cdn.upyun.sugarat.top/mdImg/sugar/2575c2b78175405f64fd2c63026c349c" alt="" loading="lazy"></td><td style="text-align:center;"><img src="https://cdn.upyun.sugarat.top/mdImg/sugar/731ae02b64e7e5fdf0fb38076249ccca" alt="" loading="lazy"></td></tr></tbody></table><h3 id="限速" tabindex="-1">限速 <a class="header-anchor" href="#限速" aria-label="Permalink to “限速”">​</a></h3><p>限制单 IP 的QPS和峰值流量。</p><p><img src="https://cdn.upyun.sugarat.top/mdImg/sugar/48e0434cdeba4e8fd1b95a18c7a48405" alt="" loading="lazy"></p><p>但是这个只能避免说让它刷得慢一点，还是不治本。</p><p><img src="https://cdn.upyun.sugarat.top/mdImg/sugar/d1722bb89b9a6375dc121ba836cba8bb" alt="" loading="lazy"></p><h2 id="最后" tabindex="-1">最后 <a class="header-anchor" href="#最后" aria-label="Permalink to “最后”">​</a></h2><p>用了CDN的话，日常还是多看看，能加阈值控制的平台优先加上，常规的访问控制防盗链的啥的安排上。</p><p><img src="https://cdn.upyun.sugarat.top/mdImg/sugar/fbb1b5771c16c9d715c026e5aa2154b7" alt="" loading="lazy"></p>',40)])])}const m=e(c,[["render",n]]);export{g as __pageData,m as default};
